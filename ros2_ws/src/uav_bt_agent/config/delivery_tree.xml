<root BTCPP_format="4" main_tree_to_execute="MainTree">

  <!-- ============================================================ -->
  <!-- MAIN TREE: Safety + Mission                                   -->
  <!-- ============================================================ -->
  <BehaviorTree ID="MainTree">
    <ReactiveSequence>

      <!-- LAYER 1: Always-on safety (checked every tick) -->
      <SubTree ID="SafetyMonitor" />

      <!-- LAYER 2: Mission lifecycle -->
      <Fallback>
        <SubTree ID="DeliveryMission" />
        <SubTree ID="EmergencyProcedure" />
      </Fallback>

    </ReactiveSequence>
  </BehaviorTree>

  <!-- ============================================================ -->
  <!-- SAFETY MONITOR (runs every tick, aborts mission on failure)   -->
  <!-- ============================================================ -->
  <BehaviorTree ID="SafetyMonitor">
    <Parallel success_count="3" failure_count="1">
      <IsBatteryOk threshold="{battery_min}" />
      <IsInGeofence />
      <IsSlamHealthy />
    </Parallel>
  </BehaviorTree>

  <!-- ============================================================ -->
  <!-- EMERGENCY PROCEDURE (triggered when safety fails)            -->
  <!-- ============================================================ -->
  <BehaviorTree ID="EmergencyProcedure">
    <Sequence>
      <EchoAction message="⚠️ EMERGENCY: Safety check failed!" />
      <PublishStatusAction status="EMERGENCY" reason="Safety violation" />
      <Fallback>
        <ReturnToHomeAction />
        <EmergencyLandAction />
      </Fallback>
    </Sequence>
  </BehaviorTree>

  <!-- ============================================================ -->
  <!-- DELIVERY MISSION                                              -->
  <!-- ============================================================ -->
  <BehaviorTree ID="DeliveryMission">
    <Sequence>

      <!-- Wait for mission from cloud dispatch -->
      <WaitForEvent topic="/uav/mission/new" />
      <PublishStatusAction status="ACCEPTED" />

      <!-- PHASE 1: Takeoff -->
      <SubTree ID="Phase_Takeoff" />

      <!-- PHASE 2: Navigate to destination -->
      <SubTree ID="Phase_Navigate"
               goal_x="{dest_x}" goal_y="{dest_y}" goal_z="{cruise_alt}" />

      <!-- PHASE 3: Approach + Search + Precision Land -->
      <SubTree ID="Phase_Deliver" />

      <!-- PHASE 4: Wait for customer pickup -->
      <WaitAction duration="{pickup_wait_time}" />

      <!-- PHASE 5: Return to base -->
      <SubTree ID="Phase_Takeoff" />
      <SubTree ID="Phase_Navigate"
               goal_x="{home_x}" goal_y="{home_y}" goal_z="{cruise_alt}" />

      <!-- PHASE 6: Land at base -->
      <LandAction />
      <PublishStatusAction status="COMPLETED" />

    </Sequence>
  </BehaviorTree>

  <!-- ============================================================ -->
  <!-- PHASE: TAKEOFF                                                -->
  <!-- ============================================================ -->
  <BehaviorTree ID="Phase_Takeoff">
    <Sequence>
      <RetryNode num_attempts="3">
        <Sequence>
          <ArmAction />
          <SetOffboardAction />
          <TakeoffAction height="{takeoff_height}" />
        </Sequence>
      </RetryNode>
      <PublishStatusAction status="AIRBORNE" />
    </Sequence>
  </BehaviorTree>

  <!-- ============================================================ -->
  <!-- PHASE: NAVIGATE (cruise at fixed altitude)                    -->
  <!-- ============================================================ -->
  <BehaviorTree ID="Phase_Navigate">
    <Sequence>
      <PublishStatusAction status="NAVIGATING" />

      <!-- Plan path using OctoMap 3D A* -->
      <!-- Input: goal_x/y/z from Blackboard -->
      <!-- Output: planned_path to Blackboard -->
      <PlanPathAction
        goal_x="{goal_x}" goal_y="{goal_y}" goal_z="{goal_z}"
        waypoints="{planned_path}" />

      <!-- Follow planned path with obstacle monitoring -->
      <ReactiveSequence>
        <IsPathClear path="{planned_path}" />
        <FollowPathAction waypoints="{planned_path}" />
      </ReactiveSequence>

    </Sequence>
  </BehaviorTree>

  <!-- ============================================================ -->
  <!-- PHASE: DELIVER (descend + search + land)                      -->
  <!-- ============================================================ -->
  <BehaviorTree ID="Phase_Deliver">
    <Sequence>
      <PublishStatusAction status="APPROACHING" />

      <!-- Descend to search altitude -->
      <GoToAction x="{dest_x}" y="{dest_y}" z="{search_alt}" yaw="0" />

      <!-- Search and land -->
      <Fallback>

        <!-- ATTEMPT 1: Full precision landing -->
        <Sequence>
          <!-- Search for max 30 seconds -->
          <TimeoutNode msec="30000">
             <!-- Assuming SearchMarkerAction returns SUCCESS if found, RUNNING while searching -->
            <SearchMarkerAction marker_id="{target_marker_id}"
                                marker_x="{marker_x}" marker_y="{marker_y}" />
          </TimeoutNode>

          <RetryNode num_attempts="3">
            <ReactiveSequence>
              <IsMarkerVisible marker_id="{target_marker_id}" />
              <PrecisionLandAction marker_id="{target_marker_id}" />
            </ReactiveSequence>
          </RetryNode>

          <PublishStatusAction status="DELIVERED" />
        </Sequence>

        <!-- ATTEMPT 2: Land at approximate position -->
        <Sequence>
          <EchoAction message="Marker not found, landing at GPS position" />
          <LandAction />
          <PublishStatusAction status="DELIVERED_APPROX"
                               reason="Marker not found" />
        </Sequence>

      </Fallback>
    </Sequence>
  </BehaviorTree>

</root>
