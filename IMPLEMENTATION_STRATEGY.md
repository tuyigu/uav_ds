# UDS 项目实现思路与技术架构指南

本手册旨在为 UDS 项目提供深度的工程实现思路，涵盖从底层控制到云端调度的全链路细节，重点解决“末端 100 米”可靠性与异构系统集成问题。

---

## 一、 核心架构：控制与观测的解耦并行

### 1. “并列关系”设计
*   **ROS 2 控制流**：负责业务逻辑、行为树决策、路径执行。
*   **WebRTC 观测流**：独立于 ROS 2 的 Linux 进程。直接读取 `/dev/video0`，绕过 ROS 消息序列化，确保 <200ms 的视频延迟。
*   **优势**：即使 ROS 2 核心节点崩溃，云端依然能通过 WebRTC 看到画面并实施紧急接管。

### 2. 任务分配：从“拉”模式到“推”模式
*   **Web Server (FastAPI)**：维护无人机状态表（电量、坐标、负载）。
*   **调度算法**：后端定时扫描未分配订单，计算最优无人机并主动推送到对应的 `AgentNode`。
*   **协议**：使用 WebSocket 保持长连接，实现指令的毫秒级下发。

---

## 二、 行为树 (Behavior Tree) 逻辑深度

行为树不只是顺序执行器，更是**异常处理中心**。

### 1. 节点设计分层
*   **根节点 (Parallel)**：左侧为“安全监控子树”（始终运行），右侧为“任务执行子树”。
*   **安全监控**：实时检查 `IsBatteryOk?`、`ObstacleDistance > Threshold?`、`GpsAccuracy?`。
*   **任务执行**：采用 `Sequence` 与 `Fallback` 嵌套。
    *   *示例*：`MoveToGoal` 失败时，触发 `Fallback` 下的 `Recovery_Hover`（原位悬停等待）或 `Retry_Path`（重新规划）。

### 2. 状态保持与断点续传
*   利用 BT 的 `Yield` 机制，在因避障挂起任务时，记录当前进度。当避障结束，行为树能够从“上次中断的航点”继续执行，而非重新开始。

---

## 三、 “末端 100 米”可靠性闭环方案

这是系统专业性的核心体现，解决 GPS 无法承载精准降落的问题。

### 1. 定位模式接力 (Sensor Handover)
*   **100m - 10m**：依赖 GPS + SLAM。行为树调用全局规划指令。
*   **10m - 2m**：激活视觉。行为树开启 `Search_Marker` 节点。一旦识别到目标，立即切换至 **局部坐标系锚定**。
*   **2m - 0m**：视觉伺服 (Visual Servoing)。直接输出机体速度向量，将目标对准图像中心。

### 2. 坐标系转换逻辑
*   **意图驱动**：大模型或 Web 指令给出“红色桌子”。
*   **几何锁定**：利用内参将像素点转化为相机系 3D 坐标 -> 转换到机体系 -> 转换到局部 Odom 系。
*   **可靠性**：不再看全局经纬度，只看“我距离降落点还有几米”。

---

## 四、 执行层 (Flight Layer) 的专业优化

### 1. 影子目标 (Shadow Target) 算法
*   **目的**：解决 setpoint 突变。
*   **实现**：在 `flight` 节点内部建立一个“虚拟追踪点”，以受限的速度和加速度向目标点移动，将该追踪点发给 PX4。

### 2. 高质量 Action 反馈
*   Action 必须实时上报 `Distance_to_Goal` 和 `ETA`。
*   当行为树感知到进度停滞（例如 5 秒内距离未减少），主动触发重试逻辑。

---

## 五、 个人开发的工程“捷径”

为了集中精力于架构与决策，在非核心环节采用以下省力方案：

### 1. 仿真环境构建
*   **不自建模型**：利用现成的 Gazebo 城市包（如 AWS RoboMaker 系列）。
*   **按需精细化**：仅对起降点进行视觉特征增强（贴 ArUco 码或色块），中间路段保持粗糙白模。

### 2. Web 地图与规划
*   **2D 地图**：前端调用 Leaflet.js 结合 OpenStreetMap 瓦片图。
*   **全局规划**：Web 后端将城市简化为 2D 栅格，运行简单的 A* 算法生成路径折线，直接发给无人机。

---

## 六、 精力分配原则 (80/20 法则)

*   **40% 精力**：行为树的复杂逻辑与容错处理。
*   **25% 精力**：Web 与 ROS 2 之间的异步通信与状态对齐。
*   **20% 精力**：末端 100 米的视觉对准与降落闭环。
*   **15% 精力**：Flight 层的 FSM 鲁棒性与平滑控制。

---

## 七、 总结：架构师的视角

*   **不追求单点算法的最优，追求系统全局的确定性。**
*   **不迷信端到端的大模型，采用“语义-几何”分层驱动。**
*   **始终为“失败”预留路径，实现人在回路的最高权限接管。**
